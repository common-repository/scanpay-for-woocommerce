"use strict";(()=>{function x(t,e){if(!t)return e;try{return JSON.parse(t)}catch{return e}}function f(t,e=!1){if(!e){let n=localStorage.getItem("scanpay_lastPing"),r=Math.floor(Date.now()/1e3)-300;if(n&&parseInt(n,10)>r)return Promise.resolve(parseInt(n,10))}return fetch("../wp-scanpay/fetch?x=ping&s="+t,{headers:{"X-Scanpay":"fetch"}}).then(async n=>{let r=await n.text();if(n.status!==200)throw new Error(r);return r}).then(n=>(localStorage.setItem("scanpay_lastPing",n),parseInt(n,10)))}function m(){let t=x(localStorage.getItem("scanpay_version"),{version:"",expires:0});return t.expires>Date.now()?Promise.resolve(t.version):fetch("https://api.github.com/repos/scanpay/woocommerce-scanpay/releases/latest").then(e=>{if(e.status!==200)throw new Error(e.statusText);return e.json()}).then(({tag_name:e})=>{let n=e.substring(1);return localStorage.setItem("scanpay_version",JSON.stringify({version:n,expires:Date.now()+3600*1e3})),n})}function h(t,e){let n=t.split(".").map(Number),r=e.split(".").map(Number),v=Math.max(n.length,r.length);for(let i=0;i<v;i++){let p=n[i]??0,u=r[i]??0;if(p!==u)return p>u}return!1}function a(t,e="error"){let n=document.createElement("div");n.className="wcsp-meta-alert wcsp-meta-alert-"+e,n.innerHTML=t,document.getElementById("wcsp-meta-head").appendChild(n)}function c(t){let e="";for(let n of t)e+=`<li class="wcsp-meta-li">
			<div class="wcsp-meta-li-title">${n[0]}:</div>
			<div class="wcsp-meta-li-value">${n[1]}</div>
		</li>`;document.getElementById("wcsp-meta-ul").innerHTML=e}function g(){m().then(t=>{h(t,"2.6.2")&&a(`Your scanpay plugin is <b class="scanpay-outdated">outdated</b>. Please update to ${t}
				(<a href="//github.com/scanpay/woocommerce-scanpay/releases" target="_blank">changelog</a>)`,"info")})}function y(t){f(t).then(e=>{let n=Math.floor((Math.floor(Date.now()/1e3)-e)/60);if(e===0||n>60*24*3)return a(`Your plugin is not synchronized with the Scanpay backend. Please follow the instructions
				<a href="https://wordpress.org/plugins/scanpay-for-woocommerce/#installation">here</a>.`);n>10&&a("Your scanpay extension is out of sync: "+n+"minutes since last synchronization.")})}var s=document.getElementById("wcsp-meta").dataset,w=s.secret,E=wcSettings.currency.decimalSeparator===","?"da-DK":"en-US",o=new Intl.NumberFormat(E,{style:"currency",currency:"DKK"}),l=0;function I(t){let e=[["Authorized",o.format(t.authorized)],["Captured",o.format(t.captured)]];return t.voided>0?e.push(["Voided",o.format(t.voided)],["Net payment",o.format(t.captured)]):t.refunded>0?e.push(["Refunded",o.format(t.refunded)],["Net payment",o.format(t.captured-t.refunded)]):e.push(["Net payment",o.format(t.captured)]),e}function S(t){let e="",n="https://dashboard.scanpay.dk/"+t.shopid+"/"+t.id;t.captured==="0"?e=`<a target="_blank" href="${n}" class="wcsp-meta-acts-refund">Void payment</a>`:parseFloat(t.refunded)<parseFloat(t.authorized)&&(e=`<a target="_blank" href="${n}/refund" class="wcsp-meta-acts-refund">Refund</a>`),document.getElementById("wcsp-meta-foot").innerHTML=`<div class="wcsp-meta-acts"><div class="wcsp-meta-acts-left"><a target="_blank" href="${n}" class="wcsp-meta-acts-link"></a></div>${e}</div>`}function T(t){if(t==="not found"){if(!s.payid)return a("No payment details found for this order.");let e=30-Math.floor((Date.now()/1e3-s.ptime)/60);e>0?a(`The order has not been paid yet. The payment link expires in ${e} minutes.`):a("The payment link has expired. No payment received."),c([["Pay ID",s.payid]])}else t==="invalid shopid"&&a("Invalid or missing API key. Please check your plugin settings or contact support.");document.getElementById("wcsp-meta-ul").innerHTML="",document.getElementById("wcsp-meta-foot").innerHTML=""}function k(){let t=document.getElementById("wcsp-meta-head"),e=Array.from(t.children),n=!1;for(let r of e)r.classList.contains("wcsp-meta-info")||(r.remove(),n=!0);return n}var d;function b(){if(!s.id)return;d=new AbortController;let t=k();fetch("../wp-scanpay/fetch?x=meta&s="+w+"&oid="+s.id+"&rev="+l,{signal:d.signal,headers:{"X-Scanpay":"fetch"}}).then(e=>e.json()).then(e=>{if(e.error)return T(e.error);if(!(e.rev===l&&!t)){if(c(I(e)),S(e),s.status==="completed"||s.status==="refunded"){let n=parseFloat(e.captured)-parseFloat(e.refunded);parseFloat(s.total)!==n&&a("The order total (<b><i>"+o.format(parseFloat(s.total??"0"))+"</i></b>) does not match the net payment.")}l=e.rev}}).catch(({name:e})=>{e!=="AbortError"&&a("Error: could not load payment details.")}),y(w)}b();g();document.addEventListener("visibilitychange",()=>{if(document.visibilityState=="visible")return b();d.abort()});})();
